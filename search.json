[{"path":"https://keaven.github.io/nbDesign/articles/sample_size_nbinom.html","id":"methodology","dir":"Articles","previous_headings":"","what":"Methodology","title":"Sample Size Calculation for Negative Binomial Outcomes","text":"assume outcome YY follows negative binomial distribution mean Î¼\\mu dispersion parameter kk, variance given : Var(Y)=Î¼+kÎ¼2 Var(Y) = \\mu + k \\mu^2 Note Râ€™s rnbinom parameterization, k=1/ðšœðš’ðš£ðšŽk = 1/\\texttt{size}. wish test null hypothesis H0:Î»1=Î»2H_0: \\lambda_1 = \\lambda_2 alternative H1:Î»1â‰ Î»2H_1: \\lambda_1 \\neq \\lambda_2, Î»1\\lambda_1 Î»2\\lambda_2 event rates control treatment groups, respectively. function implements two methods:","code":""},{"path":"https://keaven.github.io/nbDesign/articles/sample_size_nbinom.html","id":"method-1-zhu-and-lakkis-2014","dir":"Articles","previous_headings":"Methodology","what":"Method 1: Zhu and Lakkis (2014)","title":"Sample Size Calculation for Negative Binomial Outcomes","text":"method based asymptotic normality log rate ratio. sample size control group (n1n_1) : n1=(zÎ±/s+zÎ²)2â‹…V(log(Î¼1/Î¼2))2 n_1 = \\frac{(z_{\\alpha/s} + z_{\\beta})^2 \\cdot V}{(\\log(\\mu_1/\\mu_2))^2} VV variance component: V=(1Î¼1+k)+1r(1Î¼2+k) V = \\left(\\frac{1}{\\mu_1} + k\\right) + \\frac{1}{r}\\left(\\frac{1}{\\mu_2} + k\\right) r=n2/n1r = n_2/n_1 allocation ratio, Î¼i=Î»iâ‹…t\\mu_i = \\lambda_i \\cdot t expected mean count exposure duration tt.","code":""},{"path":"https://keaven.github.io/nbDesign/articles/sample_size_nbinom.html","id":"method-2-friede-and-schmidli-2010-mÃ¼tze-et-al--2018","dir":"Articles","previous_headings":"Methodology","what":"Method 2: Friede and Schmidli (2010) / MÃ¼tze et al.Â (2018)","title":"Sample Size Calculation for Negative Binomial Outcomes","text":"method uses Wald test statistic commonly used group sequential designs (implemented gscounts package). total sample size ntotaln_{total} calculated : ntotal=(zÎ±/s+zÎ²)2â‹…Vâ€¾(log(Î»1/Î»2))2 n_{total} = \\frac{(z_{\\alpha/s} + z_{\\beta})^2 \\cdot \\bar{V}}{(\\log(\\lambda_1/\\lambda_2))^2} Vâ€¾\\bar{V} average variance per subject: Vâ€¾=1/Î¼1+kp1+1/Î¼2+kp2 \\bar{V} = \\frac{1/ \\mu_1 + k}{p_1} + \\frac{1/ \\mu_2 + k}{p_2} p1=n1/ntotalp_1 = n_1/n_{total} p2=n2/ntotalp_2 = n_2/n_{total} allocation proportions. Note: fixed design equal allocation, methods yield identical sample sizes.","code":""},{"path":"https://keaven.github.io/nbDesign/articles/sample_size_nbinom.html","id":"average-exposure-with-variable-accrual-and-dropout","dir":"Articles","previous_headings":"","what":"Average Exposure with Variable Accrual and Dropout","title":"Sample Size Calculation for Negative Binomial Outcomes","text":"accrual rate constant trial fixed duration ongoing recruitment, exposure time patients vary. function calculates average exposure time use sample size formula. Additionally, dropout_rate specified, exposure adjusted account patients leaving study early. Let TT total trial duration. Suppose recruitment occurs JJ segments, jj-th segment accrual rate RjR_j duration DjD_j. dropout_rate 0: number patients recruited segment jj Nj=Rjâ‹…DjN_j = R_j \\cdot D_j. start time segment jj Sjâˆ’1=âˆ‘=1jâˆ’1DiS_{j-1} = \\sum_{=1}^{j-1} D_i (S0=0S_0 = 0). midpoint recruitment segment jj Mj=Sjâˆ’1+Dj/2M_j = S_{j-1} + D_j/2. average follow-(exposure) time patients recruited segment jj approximately Ej=Tâˆ’MjE_j = T - M_j. dropout_rate (Î´\\delta) > 0, average exposure calculated integrating exposure function recruitment interval: Ej=1Î´âˆ’1Î´2Dj(eâˆ’Î´uminâˆ’eâˆ’Î´umax) E_j = \\frac{1}{\\delta} - \\frac{1}{\\delta^2 D_j} \\left( e^{-\\delta u_{min}} - e^{-\\delta u_{max}} \\right)  umaxu_{max} uminu_{min} maximum minimum potential follow-times patients segment (Tâˆ’Sjâˆ’1T - S_{j-1} Tâˆ’(Sjâˆ’1+Dj)T - (S_{j-1} + D_j) respectively).","code":""},{"path":"https://keaven.github.io/nbDesign/articles/sample_size_nbinom.html","id":"maximum-follow-up","dir":"Articles","previous_headings":"Average Exposure with Variable Accrual and Dropout","what":"Maximum Follow-up","title":"Sample Size Calculation for Negative Binomial Outcomes","text":"max_followup (FF) specified, follow-time individual capped FF. creates three scenarios recruitment segment: truncated: uminâ‰¥Fu_{min} \\ge F, patients segment potential follow-â‰¥F\\ge F, actual follow-FF (subject dropout). None truncated: umaxâ‰¤Fu_{max} \\le F, patients reach cap FF trial ends. calculation . Partial truncation: umin<F<umaxu_{min} < F < u_{max}, patients recruited earlier segment capped FF, recruited later followed trial end. segment split two parts calculation. overall average exposure used calculation weighted average: tâ€¾=âˆ‘j=1JNjEjâˆ‘j=1JNj \\bar{t} = \\frac{\\sum_{j=1}^J N_j E_j}{\\sum_{j=1}^J N_j}","code":""},{"path":[]},{"path":"https://keaven.github.io/nbDesign/articles/sample_size_nbinom.html","id":"basic-calculation-zhu-and-lakkis","dir":"Articles","previous_headings":"Examples","what":"Basic Calculation (Zhu and Lakkis)","title":"Sample Size Calculation for Negative Binomial Outcomes","text":"Calculate sample size : * Control rate Î»1=0.5\\lambda_1 = 0.5 * Treatment rate Î»2=0.3\\lambda_2 = 0.3 * Dispersion k=0.1k = 0.1 * Power = 80% * Alpha = 0.025 (one-sided) * Fixed exposure duration = 1 year","code":"sample_size_nbinom(   lambda1 = 0.5,   lambda2 = 0.3,   dispersion = 0.1,   power = 0.8,   alpha = 0.025,   sided = 1,   exposure = 1,   method = \"zhu\" ) #> $n1 #> [1] 167 #>  #> $n2 #> [1] 167 #>  #> $n_total #> [1] 334 #>  #> $alpha #> [1] 0.025 #>  #> $sided #> [1] 1 #>  #> $power #> [1] 0.8 #>  #> $exposure #> [1] 1 #>  #> $events_n1 #> [1] 83.5 #>  #> $events_n2 #> [1] 50.1 #>  #> $total_events #> [1] 133.6 #>  #> $variance #> [1] 0.03313373 #>  #> $accrual_rate #> NULL #>  #> $accrual_duration #> NULL"},{"path":"https://keaven.github.io/nbDesign/articles/sample_size_nbinom.html","id":"using-friede-et-al--method","dir":"Articles","previous_headings":"Examples","what":"Using Friede et al.Â Method","title":"Sample Size Calculation for Negative Binomial Outcomes","text":"","code":"sample_size_nbinom(   lambda1 = 0.5,   lambda2 = 0.3,   dispersion = 0.1,   power = 0.8,   alpha = 0.025,   sided = 1,   exposure = 1,   method = \"friede\" ) #> $n1 #> [1] 167 #>  #> $n2 #> [1] 167 #>  #> $n_total #> [1] 334 #>  #> $alpha #> [1] 0.025 #>  #> $sided #> [1] 1 #>  #> $power #> [1] 0.8 #>  #> $exposure #> [1] 1 #>  #> $events_n1 #> [1] 83.5 #>  #> $events_n2 #> [1] 50.1 #>  #> $total_events #> [1] 133.6 #>  #> $variance #> [1] 0.03313373 #>  #> $accrual_rate #> NULL #>  #> $accrual_duration #> NULL"},{"path":"https://keaven.github.io/nbDesign/articles/sample_size_nbinom.html","id":"piecewise-constant-accrual","dir":"Articles","previous_headings":"Examples","what":"Piecewise Constant Accrual","title":"Sample Size Calculation for Negative Binomial Outcomes","text":"Consider trial recruitment ramps : * 5 patients/month first 3 months * 10 patients/month next 3 months * Total trial duration 12 months function automatically calculates average exposure based accrual pattern.","code":"sample_size_nbinom(   lambda1 = 0.5,   lambda2 = 0.3,   dispersion = 0.1,   power = 0.8,   accrual_rate = c(5, 10),   accrual_duration = c(3, 3),   trial_duration = 12 ) #> $n1 #> [1] 25 #>  #> $n2 #> [1] 25 #>  #> $n_total #> [1] 50 #>  #> $alpha #> [1] 0.025 #>  #> $sided #> [1] 1 #>  #> $power #> [1] 0.8 #>  #> $exposure #> [1] 8.5 #>  #> $events_n1 #> [1] 106.25 #>  #> $events_n2 #> [1] 63.75 #>  #> $total_events #> [1] 170 #>  #> $variance #> [1] 0.03309804 #>  #> $accrual_rate #> [1]  5.555556 11.111111 #>  #> $accrual_duration #> [1] 3 3"},{"path":"https://keaven.github.io/nbDesign/articles/sample_size_nbinom.html","id":"accrual-with-dropout-and-max-follow-up","dir":"Articles","previous_headings":"Examples","what":"Accrual with Dropout and Max Follow-up","title":"Sample Size Calculation for Negative Binomial Outcomes","text":"design , 5% dropout rate per unit time maximum follow-6 months.","code":"sample_size_nbinom(   lambda1 = 0.5,   lambda2 = 0.3,   dispersion = 0.1,   power = 0.8,   accrual_rate = c(5, 10),   accrual_duration = c(3, 3),   trial_duration = 12,   dropout_rate = 0.05,   max_followup = 6 ) #> $n1 #> [1] 37 #>  #> $n2 #> [1] 37 #>  #> $n_total #> [1] 74 #>  #> $alpha #> [1] 0.025 #>  #> $sided #> [1] 1 #>  #> $power #> [1] 0.8 #>  #> $exposure #> [1] 5.183636 #>  #> $events_n1 #> [1] 95.89726 #>  #> $events_n2 #> [1] 57.53836 #>  #> $total_events #> [1] 153.4356 #>  #> $variance #> [1] 0.03321294 #>  #> $accrual_rate #> [1]  8.222222 16.444444 #>  #> $accrual_duration #> [1] 3 3"},{"path":"https://keaven.github.io/nbDesign/articles/sample_size_nbinom.html","id":"calculating-power-for-fixed-design","dir":"Articles","previous_headings":"Examples","what":"Calculating Power for Fixed Design","title":"Sample Size Calculation for Negative Binomial Outcomes","text":"Using accrual rates design previous example, suppose want calculate power treatment effect smaller (Î»2=0.4\\lambda_2 = 0.4 instead 0.30.3). use accrual_rate computed previous step.","code":"# Store the result from the previous calculation design_result <- sample_size_nbinom(   lambda1 = 0.5,   lambda2 = 0.3,   dispersion = 0.1,   power = 0.8,   accrual_rate = c(5, 10),   accrual_duration = c(3, 3),   trial_duration = 12,   dropout_rate = 0.05,   max_followup = 6 )  # Use the computed accrual rates to calculate power for a smaller effect size sample_size_nbinom(   lambda1 = 0.5,   lambda2 = 0.4, # Smaller effect size   dispersion = 0.1,   power = NULL, # Request power calculation   accrual_rate = design_result$accrual_rate, # Use computed rates   accrual_duration = c(3, 3),   trial_duration = 12,   dropout_rate = 0.05,   max_followup = 6 ) #> $n1 #> [1] 37 #>  #> $n2 #> [1] 37 #>  #> $n_total #> [1] 74 #>  #> $alpha #> [1] 0.025 #>  #> $sided #> [1] 1 #>  #> $power #> [1] 0.2589364 #>  #> $exposure #> [1] 5.183636 #>  #> $events_n1 #> [1] 95.89726 #>  #> $events_n2 #> [1] 76.71781 #>  #> $total_events #> [1] 172.6151 #>  #> $variance #> [1] 0.02886802 #>  #> $accrual_rate #> [1]  8.222222 16.444444 #>  #> $accrual_duration #> [1] 3 3"},{"path":"https://keaven.github.io/nbDesign/articles/sample_size_nbinom.html","id":"unequal-allocation","dir":"Articles","previous_headings":"Examples","what":"Unequal Allocation","title":"Sample Size Calculation for Negative Binomial Outcomes","text":"Sample size 2:1 allocation ratio (n2=2n1n_2 = 2 n_1).","code":"sample_size_nbinom(   lambda1 = 0.5,   lambda2 = 0.3,   dispersion = 0.1,   ratio = 2 ) #> $n1 #> [1] 154 #>  #> $n2 #> [1] 308 #>  #> $n_total #> [1] 462 #>  #> $alpha #> [1] 0.025 #>  #> $sided #> [1] 1 #>  #> $power #> [1] 0.9 #>  #> $exposure #> [1] 1 #>  #> $events_n1 #> [1] 77 #>  #> $events_n2 #> [1] 92.4 #>  #> $total_events #> [1] 169.4 #>  #> $variance #> [1] 0.02478355 #>  #> $accrual_rate #> NULL #>  #> $accrual_duration #> NULL"},{"path":"https://keaven.github.io/nbDesign/articles/sample_size_nbinom.html","id":"references","dir":"Articles","previous_headings":"","what":"References","title":"Sample Size Calculation for Negative Binomial Outcomes","text":"Zhu, H., & Lakkis, H. (2014). Sample size calculation comparing two negative binomial rates clinical trials. Statistics Biopharmaceutical Research, 6(1), 107-115. Friede, T., & Schmidli, H. (2010). Sample size estimation clinical trials negative binomial rates. Methods Information Medicine, 49(6), 623-631. MÃ¼tze, T., Glimm, E., Schmidli, H., & Friede, T. (2018). Group sequential designs negative binomial outcomes. Statistical Methods Medical Research, 27(10), 2978-2993.","code":""},{"path":"https://keaven.github.io/nbDesign/articles/simulation_example.html","id":"simulation-setup","dir":"Articles","previous_headings":"","what":"Simulation Setup","title":"Simulation of Recurrent Events","text":"simulate small trial following parameters: Enrollment: 20 patients total, recruited 5 months constant rate. Treatments: Two groups (Control vs.Â Experimental) 1:1 allocation ratio. Control: 0.5 events per year. Experimental: 0.3 events per year. Control: 10% annual dropout rate. Experimental: 5% annual dropout rate. Maximum Follow-: patient followed maximum 2 years randomization.","code":""},{"path":"https://keaven.github.io/nbDesign/articles/simulation_example.html","id":"defining-input-parameters","dir":"Articles","previous_headings":"Simulation Setup","what":"Defining Input Parameters","title":"Simulation of Recurrent Events","text":"","code":"# Enrollment: rate of 4 patients/month for 5 months -> ~20 patients enroll_rate <- data.frame(   rate = 4,   duration = 5 )  # Failure rates (events per unit time) fail_rate <- data.frame(   treatment = c(\"Control\", \"Experimental\"),   rate = c(0.5, 0.3) # events per year (assuming time unit is year, adjust enroll duration if needed) )  # Let's ensure time units are consistent. # If fail_rate is per year, then durations should be in years. # 5 months = 5/12 years. enroll_rate <- data.frame(   rate = 20 / (5 / 12), # 20 patients over 5/12 years   duration = 5 / 12 )  # Dropout rates (per year) dropout_rate <- data.frame(   treatment = c(\"Control\", \"Experimental\"),   rate = c(0.1, 0.05),   duration = c(100, 100) # constant rate for long duration )  # Maximum follow-up per patient (years) max_followup <- 2"},{"path":"https://keaven.github.io/nbDesign/articles/simulation_example.html","id":"running-the-simulation","dir":"Articles","previous_headings":"","what":"Running the Simulation","title":"Simulation of Recurrent Events","text":"output contains multiple rows per subject: * event = 1: actual recurrent event. * event = 0: censoring time (either due dropout reaching max_followup).","code":"set.seed(123)  sim_data <- nb_sim(   enroll_rate = enroll_rate,   fail_rate = fail_rate,   dropout_rate = dropout_rate,   max_followup = max_followup,   n = 20 )  head(sim_data) #>   id id    treatment enroll_time       tte calendar_time event #> 1  1  1      Control  0.01757203 2.0000000     2.0175720     0 #> 2  2  2 Experimental  0.02958474 0.8651927     0.8947775     1 #> 3  2  2 Experimental  0.02958474 2.0000000     2.0295847     0 #> 4  3  3 Experimental  0.05727338 2.0000000     2.0572734     0 #> 5  4  4      Control  0.05793124 2.0000000     2.0579312     0 #> 6  5  5 Experimental  0.05910231 2.0000000     2.0591023     0"},{"path":"https://keaven.github.io/nbDesign/articles/simulation_example.html","id":"analyzing-the-data","dir":"Articles","previous_headings":"","what":"Analyzing the Data","title":"Simulation of Recurrent Events","text":"can aggregate data calculate observed event rates total follow-time group.","code":"sim_dt <- as.data.table(sim_data) sim_dt[, censor_followup := ifelse(event == 0, tte, 0)] summary_stats <- sim_dt[   ,   .(     n_subjects = uniqueN(id),     total_events = sum(event == 1),     total_followup = sum(censor_followup),     observed_rate = sum(event == 1) / sum(censor_followup)   ),   by = treatment ] print(summary_stats) #>       treatment n_subjects total_events total_followup observed_rate #>          <char>      <int>        <int>          <num>         <num> #> 1:      Control         10            6       18.42088     0.3257173 #> 2: Experimental         10            5       20.00000     0.2500000"},{"path":"https://keaven.github.io/nbDesign/articles/simulation_example.html","id":"inspect-first-ten-records","dir":"Articles","previous_headings":"Analyzing the Data","what":"Inspect First Ten Records","title":"Simulation of Recurrent Events","text":"plotting, can look first ten records simulated dataset.","code":"head(sim_data, 10) #>    id id    treatment enroll_time       tte calendar_time event #> 1   1  1      Control  0.01757203 2.0000000     2.0175720     0 #> 2   2  2 Experimental  0.02958474 0.8651927     0.8947775     1 #> 3   2  2 Experimental  0.02958474 2.0000000     2.0295847     0 #> 4   3  3 Experimental  0.05727338 2.0000000     2.0572734     0 #> 5   4  4      Control  0.05793124 2.0000000     2.0579312     0 #> 6   5  5 Experimental  0.05910231 2.0000000     2.0591023     0 #> 7   6  6 Experimental  0.06569608 2.0000000     2.0656961     0 #> 8   7  7      Control  0.07224248 0.4510840     0.5233265     1 #> 9   7  7      Control  0.07224248 2.0000000     2.0722425     0 #> 10  8  8      Control  0.07526888 2.0000000     2.0752689     0"},{"path":"https://keaven.github.io/nbDesign/articles/simulation_example.html","id":"plotting-events","dir":"Articles","previous_headings":"Analyzing the Data","what":"Plotting Events","title":"Simulation of Recurrent Events","text":"can visualize events censoring times subject. avoid side-effects data.table, convert dataset back plain data frame.","code":"sim_plot <- as.data.frame(sim_data) names(sim_plot) <- make.names(names(sim_plot), unique = TRUE) events_df <- sim_plot[sim_plot$event == 1, ] censor_df <- sim_plot[sim_plot$event == 0, ]  ggplot(sim_plot, aes(x = tte, y = factor(id), color = treatment)) +   geom_line(aes(group = id), color = \"gray80\") +   geom_point(data = events_df, shape = 19, size = 2) +   geom_point(data = censor_df, shape = 4, size = 3) +   labs(     title = \"Patient Timelines\",     x = \"Time from Randomization (Years)\",     y = \"Patient ID\",     caption = \"Dots = Events, X = Censoring/Dropout\"   ) +   theme_minimal()"},{"path":"https://keaven.github.io/nbDesign/articles/simulation_example.html","id":"cutting-data-by-analysis-date","dir":"Articles","previous_headings":"","what":"Cutting Data by Analysis Date","title":"Simulation of Recurrent Events","text":"can truncate simulated data interim analysis date using cut_data_by_date(). function returns single record per participant truncated follow-time (tte) number observed events.","code":"cut_summary <- cut_data_by_date(sim_data, cut_date = 1.5) head(cut_summary) #>   id    treatment enroll_time      tte events #> 1  1      Control  0.01757203 1.482428      0 #> 2  2 Experimental  0.02958474 1.470415      1 #> 3  3 Experimental  0.05727338 1.442727      0 #> 4  4      Control  0.05793124 1.442069      0 #> 5  5 Experimental  0.05910231 1.440898      0 #> 6  6 Experimental  0.06569608 1.434304      0"},{"path":"https://keaven.github.io/nbDesign/articles/simulation_example.html","id":"wald-test-mÃ¼tze-et-al-","dir":"Articles","previous_headings":"","what":"Wald Test (MÃ¼tze et al.)","title":"Simulation of Recurrent Events","text":"Using truncated data can run Negative Binomial Wald test described MÃ¼tze et al.Â (2018).","code":"mutze_res <- mutze_test(cut_summary) mutze_res$group_summary #>      treatment subjects events exposure #> 1      Control       10      6 12.66322 #> 2 Experimental       10      4 13.63050 mutze_res$rate_ratio #> [1] 0.5370395"},{"path":"https://keaven.github.io/nbDesign/articles/simulation_example.html","id":"finding-analysis-date-for-target-events","dir":"Articles","previous_headings":"","what":"Finding Analysis Date for Target Events","title":"Simulation of Recurrent Events","text":"Often want perform interim analysis fixed calendar date, specific number events accumulated. can find date using get_analysis_date() cut data accordingly.","code":"# Target 15 total events target_events <- 15 analysis_date <- get_analysis_date(sim_data, planned_events = target_events) #> Only 11 events in trial  print(paste(\"Calendar date for\", target_events, \"events:\", round(analysis_date, 3))) #> [1] \"Calendar date for 15 events: 2.338\"  # Cut data at this date cut_events <- cut_data_by_date(sim_data, cut_date = analysis_date)  # Verify event count sum(cut_events$events) #> [1] 11"},{"path":"https://keaven.github.io/nbDesign/articles/simulation_example.html","id":"generating-and-verifying-negative-binomial-data","dir":"Articles","previous_headings":"","what":"Generating and Verifying Negative Binomial Data","title":"Simulation of Recurrent Events","text":"nb_sim() function can also generate data counts follow Negative Binomial distribution. achieved providing dispersion parameter fail_rate data frame. dispersion parameter kk relates variance mean Var(Y)=Î¼+kÎ¼2Var(Y) = \\mu + k\\mu^2.","code":""},{"path":"https://keaven.github.io/nbDesign/articles/simulation_example.html","id":"simulation-with-dispersion","dir":"Articles","previous_headings":"Generating and Verifying Negative Binomial Data","what":"Simulation with Dispersion","title":"Simulation of Recurrent Events","text":"define scenario known dispersion 0.5.","code":"# Define failure rates with dispersion fail_rate_nb <- data.frame(   treatment = \"Control\",   rate = 10,       # Mean event rate   dispersion = 0.5 # Variance = mean + 0.5 * mean^2 )  enroll_rate_nb <- data.frame(   rate = 100,   duration = 1 )  set.seed(1) # Simulate 500 subjects to get a stable estimate sim_nb <- nb_sim(   enroll_rate = enroll_rate_nb,   fail_rate = fail_rate_nb,   max_followup = 1,   n = 500,   block = \"Control\" # Assign all to Control for simplicity )"},{"path":"https://keaven.github.io/nbDesign/articles/simulation_example.html","id":"verifying-the-dispersion-parameter","dir":"Articles","previous_headings":"Generating and Verifying Negative Binomial Data","what":"Verifying the Dispersion Parameter","title":"Simulation of Recurrent Events","text":"can verify simulated data reflects input dispersion parameter estimating back data. use Method Moments (MoM) estimator: kÌ‚=Var(Y)âˆ’Yâ€¾Yâ€¾2 \\hat{k} = \\frac{Var(Y) - \\bar{Y}}{\\bar{Y}^2}","code":"# Count events per subject counts_nb <- as.data.table(sim_nb)[, .(events = sum(event)), by = id]  m <- mean(counts_nb$events) v <- var(counts_nb$events) k_mom <- (v - m) / (m^2)  # Also estimate using GLM # We use MASS::glm.nb to fit the negative binomial model # We suppress warnings because fitting intercept-only models on simulated data # can occasionally produce convergence warnings despite valid estimates. k_glm <- tryCatch({   fit <- suppressWarnings(MASS::glm.nb(events ~ 1, data = counts_nb))   1 / fit$theta }, error = function(e) NA)  print(paste(\"True Dispersion:\", 0.5)) #> [1] \"True Dispersion: 0.5\" print(paste(\"Estimated Dispersion (MoM):\", signif(k_mom, 4))) #> [1] \"Estimated Dispersion (MoM): 0.5\" print(paste(\"Estimated Dispersion (GLM):\", signif(k_glm, 4))) #> [1] \"Estimated Dispersion (GLM): 0.512\""},{"path":"https://keaven.github.io/nbDesign/authors.html","id":null,"dir":"","previous_headings":"","what":"Authors","title":"Authors and Citation","text":"Keaven Anderson. Author, maintainer.","code":""},{"path":"https://keaven.github.io/nbDesign/authors.html","id":"citation","dir":"","previous_headings":"","what":"Citation","title":"Authors and Citation","text":"Anderson K (2025). nbDesign: Sample Size Calculation Simulation Negative Binomial Outcomes. R package version 0.1.0, https://keaven.github.io/nbDesign/.","code":"@Manual{,   title = {nbDesign: Sample Size Calculation and Simulation for Negative Binomial Outcomes},   author = {Keaven Anderson},   year = {2025},   note = {R package version 0.1.0},   url = {https://keaven.github.io/nbDesign/}, }"},{"path":"https://keaven.github.io/nbDesign/index.html","id":"nbdesign","dir":"","previous_headings":"","what":"Sample Size Calculation and Simulation for Negative Binomial Outcomes","title":"Sample Size Calculation and Simulation for Negative Binomial Outcomes","text":"nbDesign provides fixed design group sequential design simulation recurrent event scenarios analyzed Poisson process negative binomial model. group sequential design, package can easily used gsDesign package. Key computation statistical information time analysis.","code":""},{"path":"https://keaven.github.io/nbDesign/index.html","id":"code-style","dir":"","previous_headings":"","what":"Code Style","title":"Sample Size Calculation and Simulation for Negative Binomial Outcomes","text":"package follows tidyverse style guide.","code":""},{"path":"https://keaven.github.io/nbDesign/reference/blinded_ssr.html","id":null,"dir":"Reference","previous_headings":"","what":"Blinded Sample Size Re-estimation for Recurrent Events â€” blinded_ssr","title":"Blinded Sample Size Re-estimation for Recurrent Events â€” blinded_ssr","text":"Estimates blinded dispersion event rate aggregated interim data calculates required sample size maintain power, assuming planned treatment effect holds. function supports constant rates (Friede & Schmidli 2010) accommodates future extensions time-varying rates (Schneider et al. 2013) using exposure-adjusted rate.","code":""},{"path":"https://keaven.github.io/nbDesign/reference/blinded_ssr.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Blinded Sample Size Re-estimation for Recurrent Events â€” blinded_ssr","text":"","code":"blinded_ssr(   data,   ratio = 1,   lambda1_planning,   lambda2_planning,   power = 0.8,   alpha = 0.025,   method = \"friede\" )"},{"path":"https://keaven.github.io/nbDesign/reference/blinded_ssr.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Blinded Sample Size Re-estimation for Recurrent Events â€” blinded_ssr","text":"data data frame containing blinded interim data. Must include columns events (number events) tte (total exposure/follow-time). typically output cut_data_by_date(). ratio Planned allocation ratio (experimental / control). Default 1. lambda1_planning Planned event rate control group used original calculation. lambda2_planning Planned event rate experimental group used original calculation. power Target power (1 - beta). Default 0.8. alpha One-sided significance level. Default 0.025. method Method sample size recalculation. Currently \"friede\" (Friede & Schmidli 2010) implemented, uses blinded nuisance parameter estimates.","code":""},{"path":"https://keaven.github.io/nbDesign/reference/blinded_ssr.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Blinded Sample Size Re-estimation for Recurrent Events â€” blinded_ssr","text":"list containing: n_total_unadjusted Original planned total sample size (based planning parameters). n_total_blinded Re-estimated total sample size using blinded estimates. dispersion_blinded Estimated dispersion parameter (k) blinded data. lambda_blinded Estimated overall event rate blinded data. info_fraction Estimated information fraction interim (blinded information / target information). blinded_info Estimated statistical information blinded interim data. target_info Target statistical information required planned power.","code":""},{"path":"https://keaven.github.io/nbDesign/reference/calculate_blinded_info.html","id":null,"dir":"Reference","previous_headings":"","what":"Calculate Blinded Statistical Information â€” calculate_blinded_info","title":"Calculate Blinded Statistical Information â€” calculate_blinded_info","text":"Estimates blinded dispersion event rate aggregated interim data calculates observed statistical information log rate ratio, assuming planned allocation ratio treatment effect.","code":""},{"path":"https://keaven.github.io/nbDesign/reference/calculate_blinded_info.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Calculate Blinded Statistical Information â€” calculate_blinded_info","text":"","code":"calculate_blinded_info(data, ratio = 1, lambda1_planning, lambda2_planning)"},{"path":"https://keaven.github.io/nbDesign/reference/calculate_blinded_info.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Calculate Blinded Statistical Information â€” calculate_blinded_info","text":"data data frame containing blinded interim data. Must include columns events (number events) tte (total exposure/follow-time). ratio Planned allocation ratio (experimental / control). Default 1. lambda1_planning Planned event rate control group. lambda2_planning Planned event rate experimental group.","code":""},{"path":"https://keaven.github.io/nbDesign/reference/calculate_blinded_info.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Calculate Blinded Statistical Information â€” calculate_blinded_info","text":"list containing: blinded_info Estimated statistical information. dispersion_blinded Estimated dispersion parameter (k). lambda_blinded Estimated overall event rate. lambda1_adjusted Re-estimated control rate. lambda2_adjusted Re-estimated experimental rate.","code":""},{"path":"https://keaven.github.io/nbDesign/reference/cut_data_by_date.html","id":null,"dir":"Reference","previous_headings":"","what":"Cut nb_sim data by calendar date â€” cut_data_by_date","title":"Cut nb_sim data by calendar date â€” cut_data_by_date","text":"Cut nb_sim data calendar date","code":""},{"path":"https://keaven.github.io/nbDesign/reference/cut_data_by_date.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Cut nb_sim data by calendar date â€” cut_data_by_date","text":"","code":"cut_data_by_date(data, cut_date, ...)"},{"path":"https://keaven.github.io/nbDesign/reference/cut_data_by_date.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Cut nb_sim data by calendar date â€” cut_data_by_date","text":"data Data generated nb_sim(). cut_date Calendar time (relative trial start) censor follow-. ... Additional arguments passed methods.","code":""},{"path":"https://keaven.github.io/nbDesign/reference/cut_data_by_date.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Cut nb_sim data by calendar date â€” cut_data_by_date","text":"data frame one row per subject randomized prior cut_date containing truncated follow-time (tte) total number observed events (events).","code":""},{"path":"https://keaven.github.io/nbDesign/reference/cut_data_by_date.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Cut nb_sim data by calendar date â€” cut_data_by_date","text":"","code":"enroll_rate <- data.frame(rate = 20 / (5 / 12), duration = 5 / 12) fail_rate <- data.frame(treatment = c(\"Control\", \"Experimental\"), rate = c(0.5, 0.3)) dropout_rate <- data.frame(   treatment = c(\"Control\", \"Experimental\"),   rate = c(0.1, 0.05), duration = c(100, 100) ) sim <- nb_sim(enroll_rate, fail_rate, dropout_rate, max_followup = 2, n = 20) cut_data_by_date(sim, cut_date = 1) #>    id    treatment enroll_time       tte events #> 1   1      Control  0.00419837 0.9958016      0 #> 2   2 Experimental  0.03844758 0.9615524      0 #> 3   3      Control  0.14626653 0.8537335      1 #> 4   4 Experimental  0.16402103 0.8359790      0 #> 5   5      Control  0.17372445 0.8262756      0 #> 6   6      Control  0.18507951 0.8149205      0 #> 7   7 Experimental  0.18557397 0.8144260      0 #> 8   8 Experimental  0.20588002 0.7941200      0 #> 9   9 Experimental  0.23301460 0.7669854      1 #> 10 10      Control  0.27367404 0.7263260      0 #> 11 11 Experimental  0.30090945 0.6990905      1 #> 12 12      Control  0.34461830 0.6553817      2 #> 13 13      Control  0.37061731 0.6293827      0 #> 14 14      Control  0.37480352 0.6251965      0 #> 15 15 Experimental  0.41551077 0.5191834      0 #> 16 16 Experimental  0.41625369 0.5837463      0 #> 17 17      Control  0.42441302 0.5755870      0 #> 18 18 Experimental  0.43226952 0.5677305      0 #> 19 19      Control  0.50772960 0.4922704      0 #> 20 20 Experimental  0.51633101 0.4836690      0"},{"path":"https://keaven.github.io/nbDesign/reference/get_analysis_date.html","id":null,"dir":"Reference","previous_headings":"","what":"Find calendar date for target event count â€” get_analysis_date","title":"Find calendar date for target event count â€” get_analysis_date","text":"Finds calendar time (since start randomization) specified total number events reached simulated dataset.","code":""},{"path":"https://keaven.github.io/nbDesign/reference/get_analysis_date.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Find calendar date for target event count â€” get_analysis_date","text":"","code":"get_analysis_date(data, planned_events)"},{"path":"https://keaven.github.io/nbDesign/reference/get_analysis_date.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Find calendar date for target event count â€” get_analysis_date","text":"data data frame simulated data, typically nb_sim(). planned_events Integer. target number events.","code":""},{"path":"https://keaven.github.io/nbDesign/reference/get_analysis_date.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Find calendar date for target event count â€” get_analysis_date","text":"Numeric. calendar date planned_events achieved. dataset contains fewer planned_events, returns maximum calendar time dataset prints message.","code":""},{"path":"https://keaven.github.io/nbDesign/reference/get_analysis_date.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Find calendar date for target event count â€” get_analysis_date","text":"","code":"enroll_rate <- data.frame(rate = 20 / (5 / 12), duration = 5 / 12) fail_rate <- data.frame(treatment = c(\"Control\", \"Experimental\"), rate = c(0.5, 0.3)) dropout_rate <- data.frame(   treatment = c(\"Control\", \"Experimental\"),   rate = c(0.1, 0.05), duration = c(100, 100) ) sim <- nb_sim(enroll_rate, fail_rate, dropout_rate, max_followup = 2, n = 40) get_analysis_date(sim, planned_events = 15) #> [1] 1.375216"},{"path":"https://keaven.github.io/nbDesign/reference/mutze_test.html","id":null,"dir":"Reference","previous_headings":"","what":"Wald test for treatment effect using Negative Binomial model (MÃ¼tze et al.) â€” mutze_test","title":"Wald test for treatment effect using Negative Binomial model (MÃ¼tze et al.) â€” mutze_test","text":"Fits Negative Binomial (Poisson) log-rate model aggregated subject-level data produced cut_data_by_date(). method matches Wald test described MÃ¼tze et al. (2018) comparing treatment arms recurrent event outcomes.","code":""},{"path":"https://keaven.github.io/nbDesign/reference/mutze_test.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Wald test for treatment effect using Negative Binomial model (MÃ¼tze et al.) â€” mutze_test","text":"","code":"mutze_test(data, method = c(\"nb\", \"poisson\"), conf_level = 0.95)"},{"path":"https://keaven.github.io/nbDesign/reference/mutze_test.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Wald test for treatment effect using Negative Binomial model (MÃ¼tze et al.) â€” mutze_test","text":"data data frame least columns treatment, events, tte (follow-time). Typically output cut_data_by_date(). method Type model fit: \"nb\" (default) uses Negative Binomial GLM via MASS::glm.nb(), \"poisson\" fits Poisson GLM. conf_level Confidence level rate ratio interval. Default 0.95.","code":""},{"path":"https://keaven.github.io/nbDesign/reference/mutze_test.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Wald test for treatment effect using Negative Binomial model (MÃ¼tze et al.) â€” mutze_test","text":"list containing fitted model summary elements: estimate: log rate ratio (experimental vs control). se: standard error log rate ratio. z: Wald statistic. p_value: two-sided p-value. rate_ratio: estimated rate ratio confidence interval. dispersion: estimated dispersion (theta) method = \"nb\". group_summary: observed subjects/events/exposure per treatment.","code":""},{"path":"https://keaven.github.io/nbDesign/reference/mutze_test.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Wald test for treatment effect using Negative Binomial model (MÃ¼tze et al.) â€” mutze_test","text":"","code":"enroll_rate <- data.frame(rate = 20 / (5 / 12), duration = 5 / 12) fail_rate <- data.frame(treatment = c(\"Control\", \"Experimental\"), rate = c(0.5, 0.3)) dropout_rate <- data.frame(   treatment = c(\"Control\", \"Experimental\"),   rate = c(0.1, 0.05), duration = c(100, 100) ) sim <- nb_sim(enroll_rate, fail_rate, dropout_rate, max_followup = 2, n = 40) cut <- cut_data_by_date(sim, cut_date = 1.5) mutze_test(cut) #> $method #> [1] \"Negative Binomial Wald\" #>  #> $estimate #> [1] -0.0905074 #>  #> $se #> [1] 0.4003344 #>  #> $z #> [1] -0.2260795 #>  #> $p_value #> [1] 0.8211396 #>  #> $rate_ratio #> [1] 0.9134676 #>  #> $conf_int #> [1] 0.4168001 2.0019740 #>  #> $conf_level #> [1] 0.95 #>  #> $dispersion #> [1] 9733.415 #>  #> $model #>  #> Call:  MASS::glm.nb(formula = events ~ treatment + offset(log(tte)),  #>     data = df, init.theta = 9733.414996, link = log) #>  #> Coefficients: #>           (Intercept)  treatmentExperimental   #>              -0.48170               -0.09051   #>  #> Degrees of Freedom: 39 Total (i.e. Null);  38 Residual #> Null Deviance:\t    33.33  #> Residual Deviance: 33.28 \tAIC: 85.12 #>  #> $group_summary #>      treatment subjects events exposure #> 1 Experimental       20     12 21.26609 #> 2      Control       20     13 21.04477 #>"},{"path":"https://keaven.github.io/nbDesign/reference/nb_sim.html","id":null,"dir":"Reference","previous_headings":"","what":"Simulate Recurrent Events with Fixed Follow-up â€” nb_sim","title":"Simulate Recurrent Events with Fixed Follow-up â€” nb_sim","text":"Simulates recurrent events clinical trial piecewise constant enrollment, exponential failure rates (Poisson process), piecewise exponential dropout.","code":""},{"path":"https://keaven.github.io/nbDesign/reference/nb_sim.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Simulate Recurrent Events with Fixed Follow-up â€” nb_sim","text":"","code":"nb_sim(   enroll_rate,   fail_rate,   dropout_rate = NULL,   max_followup = NULL,   n = NULL,   block = c(rep(\"Control\", 2), rep(\"Experimental\", 2)) )"},{"path":"https://keaven.github.io/nbDesign/reference/nb_sim.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Simulate Recurrent Events with Fixed Follow-up â€” nb_sim","text":"enroll_rate data frame columns rate duration defining piecewise constant enrollment rates. fail_rate data frame columns treatment rate defining exponential failure rate treatment group. Optionally, dispersion column can provided generate data Negative Binomial distribution. dispersion parameter k \\(Var(Y) = \\mu + k \\mu^2\\). dropout_rate data frame columns treatment, rate, duration defining piecewise constant dropout rates. max_followup Numeric. Maximum duration follow-individual (relative randomization time). n Total sample size. NULL, estimated enroll_rate. provided, enrollment stops n subjects recruited. block Block vector treatment allocation. Default c(rep(\"Control\", 2), rep(\"Experimental\", 2)). NULL, simple randomization used (treatments assigned equal probability). provided, specifies block structure, e.g., c(rep(\"\", 2), rep(\"B\", 2)) assigns 2 group 2 group B block.","code":""},{"path":"https://keaven.github.io/nbDesign/reference/nb_sim.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Simulate Recurrent Events with Fixed Follow-up â€” nb_sim","text":"data frame (tibble) columns: id Subject identifier treatment Treatment group enroll_time Time enrollment relative trial start tte Time event censoring relative randomization calendar_time Calendar time event censoring (enroll_time + tte) event Binary indicator: 1 event, 0 censoring Multiple rows per subject returned (one event, plus one final censoring time).","code":""},{"path":"https://keaven.github.io/nbDesign/reference/sample_size_nbinom.html","id":null,"dir":"Reference","previous_headings":"","what":"Sample Size Calculation for Negative Binomial Distribution â€” sample_size_nbinom","title":"Sample Size Calculation for Negative Binomial Distribution â€” sample_size_nbinom","text":"Computes sample size comparing two treatment groups assuming negative binomial distribution outcome.","code":""},{"path":"https://keaven.github.io/nbDesign/reference/sample_size_nbinom.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Sample Size Calculation for Negative Binomial Distribution â€” sample_size_nbinom","text":"","code":"sample_size_nbinom(   lambda1,   lambda2,   dispersion,   power = NULL,   alpha = 0.025,   sided = 1,   exposure = NULL,   ratio = 1,   accrual_rate = NULL,   accrual_duration = NULL,   trial_duration = NULL,   dropout_rate = 0,   max_followup = NULL,   method = \"zhu\" )"},{"path":"https://keaven.github.io/nbDesign/reference/sample_size_nbinom.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Sample Size Calculation for Negative Binomial Distribution â€” sample_size_nbinom","text":"lambda1 Rate group 1 (control). lambda2 Rate group 2 (treatment). dispersion Dispersion parameter k \\(Var(Y) = \\mu + k \\mu^2\\). Note equivalent 1/size R's rnbinom parameterization. power Power test (1 - beta). Default 0.9. alpha Significance level. Default 0.025. sided One-sided two-sided test. 1 one-sided, 2 two-sided. Default 1. exposure Duration exposure. Default 1. Ignored accrual_rate related parameters provided. ratio Allocation ratio n2/n1. Default 1. accrual_rate Vector accrual rates (patients per unit time). provided, accrual_duration trial_duration must also provided. accrual_duration Vector durations accrual rate. Must length accrual_rate. trial_duration Total planned duration trial. dropout_rate Dropout rate (hazard rate). Default 0. max_followup Maximum follow-time patient. Default NULL (infinite). method Method sample size calculation. \"zhu\" Zhu Lakkis (2014), \"friede\" Friede Schmidli (2010) / MÃ¼tze et al. (2018).","code":""},{"path":"https://keaven.github.io/nbDesign/reference/sample_size_nbinom.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Sample Size Calculation for Negative Binomial Distribution â€” sample_size_nbinom","text":"list containing: n1 Sample size group 1 n2 Sample size group 2 n_total Total sample size exposure Average exposure time used calculation","code":""},{"path":"https://keaven.github.io/nbDesign/reference/sample_size_nbinom.html","id":"references","dir":"Reference","previous_headings":"","what":"References","title":"Sample Size Calculation for Negative Binomial Distribution â€” sample_size_nbinom","text":"Zhu, H., & Lakkis, H. (2014). Sample size calculation comparing two negative binomial rates clinical trials. Statistics Biopharmaceutical Research, 6(1), 107-115. Friede, T., & Schmidli, H. (2010). Sample size estimation clinical trials negative binomial rates. Methods Information Medicine, 49(6), 623-631. MÃ¼tze, T., Glimm, E., Schmidli, H., & Friede, T. (2018). Group sequential designs negative binomial outcomes. Statistical Methods Medical Research, 27(10), 2978-2993.","code":""},{"path":"https://keaven.github.io/nbDesign/reference/sample_size_nbinom.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Sample Size Calculation for Negative Binomial Distribution â€” sample_size_nbinom","text":"","code":"# Calculate sample size for lambda1 = 0.5, lambda2 = 0.3, dispersion = 0.1 sample_size_nbinom(lambda1 = 0.5, lambda2 = 0.3, dispersion = 0.1, power = 0.8) #> $n1 #> [1] 167 #>  #> $n2 #> [1] 167 #>  #> $n_total #> [1] 334 #>  #> $alpha #> [1] 0.025 #>  #> $sided #> [1] 1 #>  #> $power #> [1] 0.8 #>  #> $exposure #> [1] 1 #>  #> $events_n1 #> [1] 83.5 #>  #> $events_n2 #> [1] 50.1 #>  #> $total_events #> [1] 133.6 #>  #> $variance #> [1] 0.03313373 #>  #> $accrual_rate #> NULL #>  #> $accrual_duration #> NULL #>   # With piecewise accrual # 5 patients/month for 3 months, then 10 patients/month for 3 months # Trial ends at month 12. sample_size_nbinom(   lambda1 = 0.5, lambda2 = 0.3, dispersion = 0.1, power = 0.8,   accrual_rate = c(5, 10), accrual_duration = c(3, 3),   trial_duration = 12 ) #> $n1 #> [1] 25 #>  #> $n2 #> [1] 25 #>  #> $n_total #> [1] 50 #>  #> $alpha #> [1] 0.025 #>  #> $sided #> [1] 1 #>  #> $power #> [1] 0.8 #>  #> $exposure #> [1] 8.5 #>  #> $events_n1 #> [1] 106.25 #>  #> $events_n2 #> [1] 63.75 #>  #> $total_events #> [1] 170 #>  #> $variance #> [1] 0.03309804 #>  #> $accrual_rate #> [1]  5.555556 11.111111 #>  #> $accrual_duration #> [1] 3 3 #>"}]
