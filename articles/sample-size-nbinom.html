<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Sample size calculation for negative binomial outcomes • gsDesignNB</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Sample size calculation for negative binomial outcomes">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">gsDesignNB</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/keaven/gsDesignNB/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Sample size calculation for negative binomial outcomes</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/keaven/gsDesignNB/blob/main/vignettes/sample-size-nbinom.Rmd" class="external-link"><code>vignettes/sample-size-nbinom.Rmd</code></a></small>
      <div class="d-none name"><code>sample-size-nbinom.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://keaven.github.io/gsDesignNB/">gsDesignNB</a></span><span class="op">)</span></span></code></pre></div>
<p>This vignette describes the methodology used in the
<code><a href="../reference/sample_size_nbinom.html">sample_size_nbinom()</a></code> function for calculating sample sizes
when comparing two treatment groups with negative binomial outcomes. It
covers two available methods and how to account for variable accrual
rates.</p>
<div class="section level2">
<h2 id="methodology">Methodology<a class="anchor" aria-label="anchor" href="#methodology"></a>
</h2>
<p>We wish to test for differences in rates of recurrent events between
two treatment groups using a negative binomial model to account for
overdispersion. The underlying test is to evaluate the log rate ratio
between the two groups. This is parameterized in terms of event rates
<span class="math inline">\(\lambda_1\)</span> and <span class="math inline">\(\lambda_2\)</span> (events per unit time) for the
control and treatment groups, respectively. The usual null hypothesis is
that the rates are equal (<span class="math inline">\(H_0: \lambda_1 =
\lambda_2\)</span>) with a one-sided alternative (<span class="math inline">\(H_1: \lambda_1 &gt; \lambda_2\)</span>). However,
non-inferiority or equivalence tests can also be performed by specifying
an appropriate null hypothesis.</p>
<div class="section level3">
<h3 id="negative-binomial-distribution">Negative binomial distribution<a class="anchor" aria-label="anchor" href="#negative-binomial-distribution"></a>
</h3>
<p>We assume the outcome <span class="math inline">\(Y\)</span> follows
a negative binomial distribution with mean <span class="math inline">\(\mu\)</span> and a common dispersion parameter
<span class="math inline">\(k\)</span> for both treatment groups, such
that the variance is given by:</p>
<p><span class="math display">\[ \mathrm{Var}(Y) = \mu + k \mu^2
\]</span></p>
<p>Note that in R’s <code><a href="https://rdrr.io/r/stats/NegBinomial.html" class="external-link">rnbinom()</a></code> parameterization, <span class="math inline">\(k = 1/\texttt{size}\)</span>.</p>
</div>
<div class="section level3">
<h3 id="connection-between-rates-and-counts">Connection between rates and counts<a class="anchor" aria-label="anchor" href="#connection-between-rates-and-counts"></a>
</h3>
<p>The negative binomial distribution can be motivated by a
Gamma-Poisson mixture model. Suppose that for each subject <span class="math inline">\(i\)</span>, the event rate <span class="math inline">\(\Lambda_i\)</span> is a random variable following
a Gamma distribution with shape <span class="math inline">\(\alpha =
1/k\)</span> and rate <span class="math inline">\(\beta = 1/(k
\lambda)\)</span>, where <span class="math inline">\(\lambda\)</span> is
the underlying population event rate and <span class="math inline">\(k\)</span> is the dispersion parameter. The mean
of this Gamma distribution is <span class="math inline">\(\mathrm{E}[\Lambda_i] = \alpha / \beta =
\lambda\)</span> and the variance is <span class="math inline">\(\mathrm{Var}(\Lambda_i) = \alpha / \beta^2 = k
\lambda^2\)</span>.</p>
<p>Given the subject-specific rate <span class="math inline">\(\Lambda_i\)</span>, the number of events <span class="math inline">\(Y_i\)</span> observed over a time period <span class="math inline">\(t_i\)</span> follows a Poisson distribution with
rate <span class="math inline">\(\Lambda_i t_i\)</span>: <span class="math display">\[ Y_i | \Lambda_i \sim \text{Poisson}(\Lambda_i
t_i) \]</span></p>
<p>The marginal distribution of <span class="math inline">\(Y_i\)</span>
(integrating out <span class="math inline">\(\Lambda_i\)</span>) is then
a negative binomial distribution with mean <span class="math inline">\(\mu_i = \lambda t_i\)</span> and dispersion
parameter <span class="math inline">\(k\)</span>. The variance is: <span class="math display">\[ \mathrm{Var}(Y_i) =
\mathrm{E}[\mathrm{Var}(Y_i|\Lambda_i)] +
\mathrm{Var}(\mathrm{E}[Y_i|\Lambda_i]) \]</span> <span class="math display">\[ = \mathrm{E}[\Lambda_i t_i] +
\mathrm{Var}(\Lambda_i t_i) \]</span> <span class="math display">\[ =
\lambda t_i + t_i^2 (k \lambda^2) \]</span> <span class="math display">\[ = \mu_i + k \mu_i^2 \]</span></p>
<p>This formulation connects the event rate <span class="math inline">\(\lambda\)</span> (used in the hypothesis testing
framework) with the expected count <span class="math inline">\(\mu\)</span> (used in the negative binomial
parameterization), showing how heterogeneity in individual rates leads
to the overdispersion characteristic of the negative binomial
distribution.</p>
</div>
<div class="section level3">
<h3 id="graphical-representation-of-negative-binomial-distributions">Graphical representation of negative binomial distributions<a class="anchor" aria-label="anchor" href="#graphical-representation-of-negative-binomial-distributions"></a>
</h3>
<p>In the following panel, we illustrate an expected value of 5 events
over a fixed time period for different dispersion parameters <span class="math inline">\(k\)</span> (0, 0.5, 1). As <span class="math inline">\(k\)</span> increases, the variance increases,
leading to a wider spread of possible event counts.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">k_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="va">k_values</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">:</span><span class="fl">15</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">k</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">x</span>, lambda <span class="op">=</span> <span class="va">mu</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">size</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">k</span></span>
<span>    <span class="va">probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/NegBinomial.html" class="external-link">dnbinom</a></span><span class="op">(</span><span class="va">x</span>, size <span class="op">=</span> <span class="va">size</span>, mu <span class="op">=</span> <span class="va">mu</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="va">probs</span>,</span>
<span>    names.arg <span class="op">=</span> <span class="va">x</span>, horiz <span class="op">=</span> <span class="cn">TRUE</span>, main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"k ="</span>, <span class="va">k</span><span class="op">)</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"Probability"</span>, ylab <span class="op">=</span> <span class="st">"Event Count"</span>, las <span class="op">=</span> <span class="fl">1</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="sample-size-nbinom_files/figure-html/unnamed-chunk-3-1.png" class="r-plt" width="768"></p>
</div>
<div class="section level3">
<h3 id="sample-size-formula">Sample size formula<a class="anchor" aria-label="anchor" href="#sample-size-formula"></a>
</h3>
<p>The sample size calculation is based on the asymptotic normality of
the log rate ratio. This approach corresponds to <strong>Method
3</strong> of <span class="citation">Zhu and Lakkis (2014)</span>, which
uses a Wald statistic for the log rate ratio. It is also the method
described by <span class="citation">Friede and Schmidli (2010)</span>
and <span class="citation">Mütze et al. (2019)</span> (as implemented in
the <code>gscounts</code> package).</p>
<p>The total sample size <span class="math inline">\(n_{\text{total}}\)</span> is calculated as:</p>
<p><span class="math display">\[ n_{\text{total}} = \frac{(z_{\alpha/s}
+ z_{\beta})^2 \cdot \tilde{V}}{(\log(\lambda_1/\lambda_2))^2}
\]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(z_{\alpha/s}\)</span> and <span class="math inline">\(z_{\beta}\)</span> are the standard normal
critical values for the significance level <span class="math inline">\(\alpha\)</span> (with <span class="math inline">\(s=1\)</span> or <span class="math inline">\(2\)</span> sided) and power <span class="math inline">\(1-\beta\)</span>.</li>
<li>
<span class="math inline">\(\lambda_1\)</span> and <span class="math inline">\(\lambda_2\)</span> are the event rates in the
control and treatment groups.</li>
<li>
<span class="math inline">\(\tilde{V}\)</span> is the average
variance per subject, defined as:</li>
</ul>
<p><span class="math display">\[ \tilde{V} = \frac{1/ \mu_1 + k}{p_1} +
\frac{1/ \mu_2 + k}{p_2} \]</span></p>
<p>where:</p>
<ul>
<li>
<span class="math inline">\(p_1 = n_1/n_{\text{total}}\)</span> and
<span class="math inline">\(p_2 = n_2/n_{\text{total}}\)</span> are the
allocation proportions.</li>
<li>
<span class="math inline">\(\mu_i = \lambda_i \cdot \bar{t}\)</span>
is the expected mean count for group <span class="math inline">\(i\)</span> over the average exposure duration
<span class="math inline">\(\bar{t}\)</span>.</li>
<li>
<span class="math inline">\(k\)</span> is the dispersion parameter.
While the cited literature assumes a common dispersion parameter across
groups, <code><a href="../reference/sample_size_nbinom.html">sample_size_nbinom()</a></code> allows for different
dispersion parameters <span class="math inline">\(k_1\)</span> and <span class="math inline">\(k_2\)</span> for the control and treatment groups,
respectively. In this case, the variance formula becomes:</li>
</ul>
<p><span class="math display">\[ \tilde{V} = \frac{1/ \mu_1 + k_1}{p_1}
+ \frac{1/ \mu_2 + k_2}{p_2} \]</span></p>
<p>This formula assumes that the exposure duration is the same for both
groups (or uses an average exposure <span class="math inline">\(\bar{t}\)</span>). However,
<code><a href="../reference/sample_size_nbinom.html">sample_size_nbinom()</a></code> allows for different dropout rates for
the two groups, which results in different average exposure durations
<span class="math inline">\(\bar{t}_1\)</span> and <span class="math inline">\(\bar{t}_2\)</span>. In this case, <span class="math inline">\(\mu_1 = \lambda_1 \bar{t}_1\)</span> and <span class="math inline">\(\mu_2 = \lambda_2 \bar{t}_2\)</span>. Also, when
the assumed gap between events is &gt; 0, the expected exposure is
impacted differently for each group based on their event rates.</p>
</div>
</div>
<div class="section level2">
<h2 id="average-exposure-with-variable-accrual-and-dropout">Average exposure with variable accrual and dropout<a class="anchor" aria-label="anchor" href="#average-exposure-with-variable-accrual-and-dropout"></a>
</h2>
<p>When the accrual rate is not constant or when the trial has a fixed
duration with ongoing recruitment, the exposure time for patients will
vary. The function calculates an <em>average exposure</em> time to use
in the sample size formula. Additionally, if a <code>dropout_rate</code>
is specified, the exposure is adjusted to account for patients leaving
the study early.</p>
<p>Let <span class="math inline">\(T\)</span> be the total trial
duration. Suppose recruitment occurs in <span class="math inline">\(J\)</span> segments, where the <span class="math inline">\(j\)</span>-th segment has accrual rate <span class="math inline">\(R_j\)</span> and duration <span class="math inline">\(D_j\)</span>.</p>
<p>If <code>dropout_rate</code> is 0:</p>
<ol style="list-style-type: decimal">
<li>The expected number of patients recruited in segment <span class="math inline">\(j\)</span> is <span class="math inline">\(N_j =
R_j \cdot D_j\)</span>.</li>
<li>The start time of segment <span class="math inline">\(j\)</span> is
<span class="math inline">\(S_{j-1} = \sum_{i=1}^{j-1} D_i\)</span>
(with <span class="math inline">\(S_0 = 0\)</span>).</li>
<li>The midpoint of recruitment for segment <span class="math inline">\(j\)</span> is <span class="math inline">\(M_j =
S_{j-1} + D_j/2\)</span>.</li>
<li>The average follow-up (exposure) time for patients recruited in
segment <span class="math inline">\(j\)</span> is approximately <span class="math inline">\(E_j = T - M_j\)</span>.</li>
</ol>
<p>If <code>dropout_rate</code> (<span class="math inline">\(\delta\)</span>) &gt; 0, the average exposure is
calculated by integrating the exposure function over the recruitment
interval:</p>
<p><span class="math display">\[
\begin{aligned}
E_j &amp;= \frac{1}{D_j}\int_{u_{\min}}^{u_{\max}} \frac{1 - e^{-\delta
u}}{\delta} du \\
&amp;= \frac{1}{\delta} - \frac{1}{\delta^2 D_j} \left( e^{-\delta
u_{\min}} - e^{-\delta u_{\max}} \right)
\end{aligned}
\]</span> where <span class="math inline">\(u_{\max}\)</span> and <span class="math inline">\(u_{\min}\)</span> are the maximum and minimum
potential follow-up times for patients in that segment (<span class="math inline">\(T - S_{j-1}\)</span> and <span class="math inline">\(T - (S_{j-1} + D_j)\)</span> respectively).</p>
<div class="section level3">
<h3 id="group-specific-parameters">Group-specific parameters<a class="anchor" aria-label="anchor" href="#group-specific-parameters"></a>
</h3>
<p>The function supports specifying <code>dropout_rate</code> as a
vector of length 2, corresponding to the control and treatment groups
respectively. This allows for scenarios where the dropout rate differs
between arms.</p>
<p>If these parameters differ, the average exposure is calculated
separately for each group (<span class="math inline">\(\bar{t}_1\)</span> and <span class="math inline">\(\bar{t}_2\)</span>). The variance inflation factor
<span class="math inline">\(Q\)</span> (see below) is also calculated
separately for each group (<span class="math inline">\(Q_1\)</span> and
<span class="math inline">\(Q_2\)</span>).</p>
</div>
<div class="section level3">
<h3 id="maximum-follow-up">Maximum follow-up<a class="anchor" aria-label="anchor" href="#maximum-follow-up"></a>
</h3>
<p>If <code>max_followup</code> (<span class="math inline">\(F\)</span>)
is specified, the follow-up time for any individual is capped at <span class="math inline">\(F\)</span>. This creates three scenarios for a
recruitment segment:</p>
<ol style="list-style-type: decimal">
<li>
<strong>All truncated:</strong> If <span class="math inline">\(u_{\min} \ge F\)</span>, all patients in the
segment have potential follow-up <span class="math inline">\(\ge
F\)</span>, so their actual follow-up is <span class="math inline">\(F\)</span> (subject to dropout).</li>
<li>
<strong>None truncated:</strong> If <span class="math inline">\(u_{\max} \le F\)</span>, no patients reach the cap
<span class="math inline">\(F\)</span> before the trial ends. The
calculation is as above.</li>
<li>
<strong>Partial truncation:</strong> If <span class="math inline">\(u_{\min} &lt; F &lt; u_{\max}\)</span>, patients
recruited earlier in the segment are capped at <span class="math inline">\(F\)</span>, while those recruited later are
followed until the trial end. The segment is split into two parts for
calculation.</li>
</ol>
<p>The overall average exposure used for the calculation is the weighted
average:</p>
<p><span class="math display">\[ \bar{t} = \frac{\sum_{j=1}^J N_j
E_j}{\sum_{j=1}^J N_j} \]</span></p>
</div>
<div class="section level3">
<h3 id="variance-inflation-for-variable-follow-up">Variance inflation for variable follow-up<a class="anchor" aria-label="anchor" href="#variance-inflation-for-variable-follow-up"></a>
</h3>
<p>When follow-up times are variable (due to accrual, dropout, or
administrative censoring), simply using the average follow-up time <span class="math inline">\(\bar{t}\)</span> in the variance formula
underestimates the true variance of the rate estimator. This is because
the variance of the negative binomial distribution depends on the
exposure time in a non-linear way (<span class="math inline">\(\mathrm{Var}(Y) = \mu + k\mu^2 = \lambda t + k
(\lambda t)^2\)</span>).</p>
<p>To account for this, we apply a variance inflation factor <span class="math inline">\(Q\)</span> to the dispersion parameter <span class="math inline">\(k\)</span>, as derived by <span class="citation">Zhu and Lakkis (2014)</span>:</p>
<p><span class="math display">\[ Q =
\frac{\mathrm{E}[t^2]}{(\mathrm{E}[t])^2} \]</span></p>
<p>The adjusted dispersion parameter used in the sample size calculation
is <span class="math inline">\(k_{\text{adj}} = k \cdot Q\)</span>. The
function automatically calculates <span class="math inline">\(\mathrm{E}[t]\)</span> and <span class="math inline">\(\mathrm{E}[t^2]\)</span> based on the accrual,
dropout, and trial duration parameters. If exposure differs between
groups, <span class="math inline">\(Q\)</span> is calculated separately
for each group.</p>
</div>
<div class="section level3">
<h3 id="event-gaps">Event gaps<a class="anchor" aria-label="anchor" href="#event-gaps"></a>
</h3>
<p>In some clinical trials, there is a mandatory “dead time” or gap
after an event during which no new events can occur (e.g., a recovery
period). If an <code>event_gap</code> is specified, the effective
exposure time for a subject is reduced by the time spent in these
gaps.</p>
<p>The function approximates the effective event rate as: <span class="math display">\[ \lambda_{\text{eff}} \approx \frac{\lambda}{1 +
\lambda \cdot \text{gap}} \]</span> This adjusted rate is then used in
the sample size calculations. The effective exposure time reported is
also adjusted similarly.</p>
</div>
</div>
<div class="section level2">
<h2 id="examples">Examples<a class="anchor" aria-label="anchor" href="#examples"></a>
</h2>
<div class="section level3">
<h3 id="basic-calculation-zhu2014sample">Basic calculation <span class="citation">(Zhu and Lakkis
2014)</span><a class="anchor" aria-label="anchor" href="#basic-calculation-zhu2014sample"></a>
</h3>
<p>Calculate sample size for:</p>
<ul>
<li>Control rate <span class="math inline">\(\lambda_1 =
0.5\)</span>
</li>
<li>Treatment rate <span class="math inline">\(\lambda_2 =
0.3\)</span>
</li>
<li>Dispersion <span class="math inline">\(k = 0.1\)</span>
</li>
<li>Power = 80%</li>
<li>Alpha = 0.025 (one-sided)</li>
<li>Accrual over 12 months</li>
<li>Trial duration 12 months (implying exposure approx 6 months)</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sample_size_nbinom.html">sample_size_nbinom</a></span><span class="op">(</span></span>
<span>  lambda1 <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  lambda2 <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  dispersion <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  power <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.025</span>,</span>
<span>  sided <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  accrual_rate <span class="op">=</span> <span class="fl">10</span>, <span class="co"># arbitrary, just for average exposure</span></span>
<span>  accrual_duration <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  trial_duration <span class="op">=</span> <span class="fl">12</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Sample size for negative binomial outcome</span></span>
<span><span class="co">#&gt; ==========================================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample size:     n1 = 35, n2 = 35, total = 70</span></span>
<span><span class="co">#&gt; Expected events: 168.0 (n1: 105.0, n2: 63.0)</span></span>
<span><span class="co">#&gt; Power: 80%, Alpha: 0.025 (1-sided)</span></span>
<span><span class="co">#&gt; Rates: control = 0.5000, treatment = 0.3000 (RR = 0.6000)</span></span>
<span><span class="co">#&gt; Dispersion: 0.1000, Avg exposure (calendar): 6.00</span></span>
<span><span class="co">#&gt; Accrual: 12.0, Trial duration: 12.0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="piecewise-constant-accrual">Piecewise constant accrual<a class="anchor" aria-label="anchor" href="#piecewise-constant-accrual"></a>
</h3>
<p>Consider a trial where recruitment ramps up:</p>
<ul>
<li>5 patients/month for the first 3 months</li>
<li>10 patients/month for the next 3 months</li>
<li>Total trial duration is 12 months</li>
</ul>
<p>The function automatically calculates the average exposure based on
this accrual pattern.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sample_size_nbinom.html">sample_size_nbinom</a></span><span class="op">(</span></span>
<span>  lambda1 <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  lambda2 <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  dispersion <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  power <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  accrual_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  accrual_duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  trial_duration <span class="op">=</span> <span class="fl">12</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Sample size for negative binomial outcome</span></span>
<span><span class="co">#&gt; ==========================================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample size:     n1 = 26, n2 = 26, total = 52</span></span>
<span><span class="co">#&gt; Expected events: 176.8 (n1: 110.5, n2: 66.3)</span></span>
<span><span class="co">#&gt; Power: 80%, Alpha: 0.025 (1-sided)</span></span>
<span><span class="co">#&gt; Rates: control = 0.5000, treatment = 0.3000 (RR = 0.6000)</span></span>
<span><span class="co">#&gt; Dispersion: 0.1000, Avg exposure (calendar): 8.50</span></span>
<span><span class="co">#&gt; Accrual: 6.0, Trial duration: 12.0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="accrual-with-dropout-and-max-follow-up">Accrual with dropout and max follow-up<a class="anchor" aria-label="anchor" href="#accrual-with-dropout-and-max-follow-up"></a>
</h3>
<p>Same design as above, but with a 5% dropout rate per unit time and a
maximum follow-up of 6 months.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sample_size_nbinom.html">sample_size_nbinom</a></span><span class="op">(</span></span>
<span>  lambda1 <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  lambda2 <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  dispersion <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  power <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  accrual_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  accrual_duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  trial_duration <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  dropout_rate <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  max_followup <span class="op">=</span> <span class="fl">6</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Sample size for negative binomial outcome</span></span>
<span><span class="co">#&gt; ==========================================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample size:     n1 = 38, n2 = 38, total = 76</span></span>
<span><span class="co">#&gt; Expected events: 157.6 (n1: 98.5, n2: 59.1)</span></span>
<span><span class="co">#&gt; Power: 80%, Alpha: 0.025 (1-sided)</span></span>
<span><span class="co">#&gt; Rates: control = 0.5000, treatment = 0.3000 (RR = 0.6000)</span></span>
<span><span class="co">#&gt; Dispersion: 0.1000, Avg exposure (calendar): 5.18</span></span>
<span><span class="co">#&gt; Dropout rate: 0.0500</span></span>
<span><span class="co">#&gt; Accrual: 6.0, Trial duration: 12.0</span></span>
<span><span class="co">#&gt; Max follow-up: 6.0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="group-specific-dropout-rates">Group-specific dropout rates<a class="anchor" aria-label="anchor" href="#group-specific-dropout-rates"></a>
</h3>
<p>Suppose the control group has a higher dropout rate (10%) than the
treatment group (5%).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sample_size_nbinom.html">sample_size_nbinom</a></span><span class="op">(</span></span>
<span>  lambda1 <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  lambda2 <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  dispersion <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  power <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  accrual_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  accrual_duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  trial_duration <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  dropout_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.10</span>, <span class="fl">0.05</span><span class="op">)</span>, <span class="co"># Control, Treatment</span></span>
<span>  max_followup <span class="op">=</span> <span class="fl">6</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Sample size for negative binomial outcome</span></span>
<span><span class="co">#&gt; ==========================================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample size:     n1 = 40, n2 = 40, total = 80</span></span>
<span><span class="co">#&gt; Expected events: 152.4 (n1: 90.2, n2: 62.2)</span></span>
<span><span class="co">#&gt; Power: 80%, Alpha: 0.025 (1-sided)</span></span>
<span><span class="co">#&gt; Rates: control = 0.5000, treatment = 0.3000 (RR = 0.6000)</span></span>
<span><span class="co">#&gt; Dispersion: 0.1000, Avg exposure (calendar): 4.51 (n1), 5.18 (n2)</span></span>
<span><span class="co">#&gt; Dropout rate: 0.1000 (n1), 0.0500 (n2)</span></span>
<span><span class="co">#&gt; Accrual: 6.0, Trial duration: 12.0</span></span>
<span><span class="co">#&gt; Max follow-up: 6.0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="calculating-power-for-fixed-design">Calculating power for fixed design<a class="anchor" aria-label="anchor" href="#calculating-power-for-fixed-design"></a>
</h3>
<p>Using the accrual rates and design from the previous example, suppose
we want to calculate the power if the treatment effect is smaller (<span class="math inline">\(\lambda_2 = 0.4\)</span> instead of <span class="math inline">\(0.3\)</span>). We use the
<code>accrual_rate</code> computed in the previous step.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Store the result from the previous calculation</span></span>
<span><span class="va">design_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_size_nbinom.html">sample_size_nbinom</a></span><span class="op">(</span></span>
<span>  lambda1 <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  lambda2 <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  dispersion <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  power <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  accrual_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  accrual_duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  trial_duration <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  dropout_rate <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  max_followup <span class="op">=</span> <span class="fl">6</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use the computed accrual rates to calculate power for a smaller effect size</span></span>
<span><span class="fu"><a href="../reference/sample_size_nbinom.html">sample_size_nbinom</a></span><span class="op">(</span></span>
<span>  lambda1 <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  lambda2 <span class="op">=</span> <span class="fl">0.4</span>, <span class="co"># Smaller effect size</span></span>
<span>  dispersion <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  power <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># Request power calculation</span></span>
<span>  accrual_rate <span class="op">=</span> <span class="va">design_result</span><span class="op">$</span><span class="va">accrual_rate</span>, <span class="co"># Use computed rates</span></span>
<span>  accrual_duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  trial_duration <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  dropout_rate <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  max_followup <span class="op">=</span> <span class="fl">6</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Sample size for negative binomial outcome</span></span>
<span><span class="co">#&gt; ==========================================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample size:     n1 = 38, n2 = 38, total = 76</span></span>
<span><span class="co">#&gt; Expected events: 177.3 (n1: 98.5, n2: 78.8)</span></span>
<span><span class="co">#&gt; Power: 26%, Alpha: 0.025 (1-sided)</span></span>
<span><span class="co">#&gt; Rates: control = 0.5000, treatment = 0.4000 (RR = 0.8000)</span></span>
<span><span class="co">#&gt; Dispersion: 0.1000, Avg exposure (calendar): 5.18</span></span>
<span><span class="co">#&gt; Dropout rate: 0.0500</span></span>
<span><span class="co">#&gt; Accrual: 6.0, Trial duration: 12.0</span></span>
<span><span class="co">#&gt; Max follow-up: 6.0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="unequal-allocation">Unequal allocation<a class="anchor" aria-label="anchor" href="#unequal-allocation"></a>
</h3>
<p>Sample size with a 2:1 allocation ratio (<span class="math inline">\(n_2 = 2 n_1\)</span>).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sample_size_nbinom.html">sample_size_nbinom</a></span><span class="op">(</span></span>
<span>  lambda1 <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  lambda2 <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  dispersion <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  ratio <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  accrual_rate <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  accrual_duration <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  trial_duration <span class="op">=</span> <span class="fl">12</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Sample size for negative binomial outcome</span></span>
<span><span class="co">#&gt; ==========================================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample size:     n1 = 40, n2 = 80, total = 120</span></span>
<span><span class="co">#&gt; Expected events: 264.0 (n1: 120.0, n2: 144.0)</span></span>
<span><span class="co">#&gt; Power: 95%, Alpha: 0.025 (1-sided)</span></span>
<span><span class="co">#&gt; Rates: control = 0.5000, treatment = 0.3000 (RR = 0.6000)</span></span>
<span><span class="co">#&gt; Dispersion: 0.1000, Avg exposure (calendar): 6.00</span></span>
<span><span class="co">#&gt; Accrual: 12.0, Trial duration: 12.0</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="accounting-for-event-gaps">Accounting for event gaps<a class="anchor" aria-label="anchor" href="#accounting-for-event-gaps"></a>
</h2>
<p>In some recurrent event trials, there may be a mandatory “gap” period
after each event during which no new events can be recorded (e.g., a
recovery period or administrative window). This effectively reduces the
time at risk.</p>
<p>If an <code>event_gap</code> (<span class="math inline">\(g\)</span>)
is specified, the function adjusts the calculation as follows:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Effective rates</strong>: The event rates are adjusted to
<span class="math inline">\(\lambda^* = \lambda / (1 + \lambda
g)\)</span> for the sample size calculation (Zhu and Lakkis
method).</li>
<li>
<strong>At-risk exposure</strong>: The function reports the “average
at-risk exposure” <span class="math inline">\(\mathrm{E}_{\text{risk}} =
\mathrm{E}_{\text{cal}} / (1 + \lambda g)\)</span> alongside the
standard calendar exposure. This provides transparency on the actual
time subjects are at risk for events.</li>
</ol>
<p>Since the gap reduction depends on the event rate (<span class="math inline">\(\lambda\)</span>), the at-risk exposure differs
between treatment groups if their rates differ, even if the calendar
exposure is the same. This is a key reason why average exposure may
differ between groups in the output.</p>
<div class="section level3">
<h3 id="example-with-event-gap">Example with event gap<a class="anchor" aria-label="anchor" href="#example-with-event-gap"></a>
</h3>
<p>Calculate sample size assuming a 30-day gap after each event (approx
0.082 years). Note how the <code>exposure_at_risk</code> differs between
groups because the group with the higher event rate (<span class="math inline">\(\lambda_1 = 2.0\)</span>) spends more time in the
“gap” period than the group with the lower rate (<span class="math inline">\(\lambda_2 = 1.0\)</span>).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sample_size_nbinom.html">sample_size_nbinom</a></span><span class="op">(</span></span>
<span>  lambda1 <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span>  lambda2 <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>  dispersion <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  power <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  accrual_rate <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  accrual_duration <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  trial_duration <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  event_gap <span class="op">=</span> <span class="fl">30</span> <span class="op">/</span> <span class="fl">365.25</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Sample size for negative binomial outcome</span></span>
<span><span class="co">#&gt; ==========================================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample size:     n1 = 9, n2 = 9, total = 18</span></span>
<span><span class="co">#&gt; Expected events: 142.7 (n1: 92.8, n2: 49.9)</span></span>
<span><span class="co">#&gt; Power: 80%, Alpha: 0.025 (1-sided)</span></span>
<span><span class="co">#&gt; Rates: control = 2.0000, treatment = 1.0000 (RR = 0.5000)</span></span>
<span><span class="co">#&gt; Dispersion: 0.1000, Avg exposure (calendar): 6.00</span></span>
<span><span class="co">#&gt; Avg exposure (at-risk): n1 = 5.15, n2 = 5.54</span></span>
<span><span class="co">#&gt; Event gap: 0.08</span></span>
<span><span class="co">#&gt; Accrual: 12.0, Trial duration: 12.0</span></span></code></pre></div>
<p>In this example, even though the calendar time is the same for both
groups, the effective at-risk exposure is lower for Group 1 because they
have more events and thus more “gap” time.</p>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-friede2010blinded" class="csl-entry">
Friede, T, and H Schmidli. 2010. <span>“Blinded Sample Size Reestimation
with Negative Binomial Counts in Superiority and Non-Inferiority
Trials.”</span> <em>Methods of Information in Medicine</em> 49 (06):
618–24.
</div>
<div id="ref-mutze2019group" class="csl-entry">
Mütze, Tobias, Ekkehard Glimm, Heinz Schmidli, and Tim Friede. 2019.
<span>“Group Sequential Designs for Negative Binomial Outcomes.”</span>
<em>Statistical Methods in Medical Research</em> 28 (8): 2326–47.
</div>
<div id="ref-zhu2014sample" class="csl-entry">
Zhu, Haiyuan, and Hassan Lakkis. 2014. <span>“Sample Size Calculation
for Comparing Two Negative Binomial Rates.”</span> <em>Statistics in
Medicine</em> 33 (3): 376–87.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Keaven Anderson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
